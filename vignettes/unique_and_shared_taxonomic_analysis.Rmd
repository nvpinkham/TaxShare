---
title: "Unique and Shared Taxonomic Analysis"
author: "Nick Pinkham"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    toc: true
    number_sections: true
vignette: >
  %\\VignetteIndexEntry{Unique and Shared Taxonomic Analysis}
  %\\VignetteEngine{knitr::rmarkdown}
  %\\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction

This vignette demonstrates the use of the package to perform **unique/shared taxonomic analyses** for comparing microbial (or ecological) communities between groups of samples. The workflow supports aggregation at user-defined taxonomic levels, statistical testing of group differences, and publication-ready visualizations.

The methods implemented here are intended for exploratory and comparative analyses of count-based community data (e.g., OTUs or ASVs) and are applicable to microbiome, ecological, and metagenomic datasets.

# Data Requirements

The package operates on three core inputs:

1. **OTU (or ASV) table**  
   A matrix or data frame of counts where rows correspond to samples and columns correspond to taxa.

2. **Sample metadata**  
   A table describing sample-level variables used to define comparison groups (e.g., treatment, season, timepoint).

3. **Taxonomic annotation table**  
   A mapping that links each OTU/ASV to one or more taxonomic ranks (e.g., family, class, genus).

# Example Data Setup

In this section, we construct a small synthetic dataset to illustrate the workflow. The example includes multiple sample groups, a secondary grouping variable, and taxonomic annotations at multiple ranks.

```{r example-data}
source("R/Functions.2026.01.22.R")

map <- list()
map$groups <- c("A", "A", "A", "A", "A", "A", "A", "A",
                "B", "B", "B", "B", "B",
                "C", "C", "C", "C")

map$season <- c("Spring", "Spring", "Spring", "Spring", "Fall", "Fall", "Fall", "Fall",
                "Spring", "Spring", "Fall", "Fall", "Fall",
                "Spring", "Spring", "Fall", "Fall")

site <- as.data.frame(matrix(nrow = 17, ncol = 5))
colnames(site) <- c("Mule", "White_tail", "Black_Bear", "Beaver", "Golden_Eagle")
rownames(site) <- paste0(seq_len(nrow(site)), ".", map$groups)

site$Mule <- c(25, 25, 14, 14, 0,0, 0, 0, 0, 0, 0, 0, 0, 21, 0, 11, 15)
site$White_tail <- c(0, 0, 0, 0, 5, 5, 5, 4, 0, 0, 10, 5, 5, 0, 0, 4, 1)
site$Black_Bear <- c(1, 2, 1, 0, 1, 0,1, 0, 2, 1, 0, 0, 0, 1, 2, 0, 0)
site$Beaver <- c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0)
site$Golden_Eagle <- c(0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 2, 0, 0, 0, 0, 1, 0)

tax <- list()
tax$family <- c("Deer", "Deer", "Bear", "Beaver", "Eagle")
tax$class <- c("Mammalia", "Mammalia", "Mammalia", "Mammalia", "Aves")
tax$species <- colnames(site)
```

# Pairwise Unique/Shared Analysis

The core analysis is performed using `tax.shared.table()`. OTUs are aggregated to a user-specified taxonomic rank, classified as unique or shared between groups, and tested for differential abundance.

```{r pairwise-analysis}
tax.table <- tax.shared.table(
  otu.input = site,
  var = map$groups,
  group1 = "A",
  group2 = "B",
  min.obs = 1,
  tax.level = tax$class,
  PresAbs = FALSE,
  fdr = TRUE,
  summary.fun = mean,
  round.to = 3
)
```

# Visualization

Results from the unique/shared analysis can be visualized using stacked bar plots.

```{r plot-pairwise, fig.width=7, fig.height=5}
par(mar = c(5, 10, 4, 4))
tax.shared.plot(
  tax.shared.table_result = tax.table,
  color1 = "salmon1",
  color2 = "lightgreen",
  log = FALSE,
  round.to = 3
)
```

# Multi-factor Comparisons

For experiments involving multiple categorical variables (e.g., season Ã— group), the `tax.shared.multicomp()` function enables simultaneous comparisons.

```{r multi-factor}
map$group.col.spring <- CAF::color.groups(map$groups, cols = c("green", "pink", "goldenrod"))
map$group.col.fall <- CAF::color.groups(map$groups, cols = c("blue", "purple", "tomato"))

tax.shared.multicomp(
  otu.input = site,
  var1 = map$season,
  var2 = map$groups,
  var1.color1 = map$group.col.spring,
  var1.color2 = map$group.col.fall,
  var1.groups = unique(map$season),
  var2.groups = unique(map$groups),
  tax.level = tax$family,
  summary.fun = mean,
  family.name.length = 3,
  fdr = FALSE,
  log = FALSE
)
```

# Application to Real Data

The same workflow can be applied to empirical datasets by loading OTU, taxonomy, and metadata tables from disk and subsetting samples based on experimental conditions.

```{r real-data, eval=FALSE}
map <- read.csv("data/map.csv", row.names = 1)
otu <- read.csv("data/otu.csv", row.names = 1)
tax <- read.csv("data/tax.csv")

p <- map$antibiotic.group == "Ibezapolstat"

tax.anti <- tax.shared.table(
  otu.input = otu[p, ],
  var = map$day2anti[p],
  group1 = "0",
  group2 = "10",
  min.obs = 1,
  tax.level = tax$family,
  PresAbs = FALSE,
  fdr = FALSE,
  summary.fun = mean,
  round.to = 3
)

par(mar = c(5, 30, 4, 4))
tax.shared.plot(
  tax.shared.table_result = tax.anti,
  log = TRUE,
  family.name.length = 3
)
```

